<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operations Notifier Admin</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --text-color: #333;
            --primary: #4f46e5;
            --secondary: #64748b;
            --danger: #ef4444;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            padding-bottom: 220px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –ª–æ–≥–∞ –≤–Ω–∏–∑—É */
        }

        .header-title {
            color: var(--primary);
            font-weight: 700;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            background-color: var(--card-bg);
        }

        .card-header {
            background-color: white;
            border-bottom: 1px solid #f1f5f9;
            font-weight: 600;
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0 !important;
        }

        .form-control, .form-select {
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 0.9rem;
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
        }

        /* Table Styles */
        .table-responsive {
            border-radius: 0 0 12px 12px;
        }
        
        .table thead th {
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e2e8f0;
        }

        .table tbody td {
            vertical-align: middle;
            font-size: 0.9rem;
            color: #334155;
        }

        .text-truncate-cell {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: help;
        }

        .badge-op {
            background-color: #e0e7ff;
            color: #4338ca;
            border: 1px solid #c7d2fe;
            margin-right: 2px;
            font-weight: 500;
        }

        .badge-asset {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .sub-row {
            cursor: pointer;
        }
        .sub-row:hover {
            background-color: #f8fafc;
        }

        .sub-details {
            background-color: #f8fafc;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', monospace;
            font-size: 0.8rem;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Bottom Log Console */
        .console-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background-color: #1e293b;
            color: #e2e8f0;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', monospace;
            z-index: 1000;
            border-top: 4px solid #334155;
            display: flex;
            flex-direction: column;
            transition: height 0.3s ease;
        }

        .console-drawer.minimized {
            height: 40px;
        }

        .console-header {
            padding: 8px 15px;
            background: #0f172a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .console-body {
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
            font-size: 0.8rem;
        }

        .log-entry {
            border-bottom: 1px solid #334155;
            padding: 4px 0;
            display: flex;
            gap: 10px;
        }

        .log-method { font-weight: bold; min-width: 50px; }
        .log-status { min-width: 40px; }
        .log-url { color: #94a3b8; flex-grow: 1; }
        .log-time { color: #64748b; min-width: 70px; text-align: right; }
        
        .status-200 { color: #4ade80; }
        .status-400, .status-500 { color: #f87171; }

        /* Status Modal Key-Value */
        .kv-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .kv-key { color: #64748b; font-size: 0.9rem; }
        .kv-val { font-weight: 500; font-family: monospace; }
    </style>
</head>
<body>

<div id="app" class="container mt-4">
    
    <!-- Header & Config -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="header-title mb-0">üõ†Ô∏è Notifier Admin</h2>
            <div class="d-flex align-items-center gap-2 mt-1">
                <span class="badge" :class="isConnected ? 'bg-success' : 'bg-secondary'">
                    {{ isConnected ? '‚óè Connected' : '‚óã Not Configured' }}
                </span>
                <small class="text-muted">{{ config.baseUrl }}</small>
            </div>
        </div>
        <div>
            <button class="btn btn-outline-info btn-sm me-2" @click="checkStatus">
                üè• Status
            </button>
            <button class="btn btn-outline-secondary btn-sm" @click="showConfig = !showConfig">
                ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </div>
    </div>

    <!-- Config Panel (Collapsible) -->
    <div v-if="showConfig" class="card mb-4 bg-light border">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-5">
                    <label class="form-label small fw-bold">Base URL</label>
                    <input v-model="config.baseUrl" class="form-control form-control-sm">
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-bold">Token</label>
                    <input v-model="config.token" type="password" class="form-control form-control-sm">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button @click="saveConfig" class="btn btn-primary btn-sm w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Subscription Card -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</span>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Account (G...)</label>
                    <input v-model="newSub.account" class="form-control" placeholder="G...">
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Reaction URL <span class="text-danger">*</span></label>
                    <input v-model="newSub.reaction_url" class="form-control" placeholder="http://...">
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Op Types (e.g. 1, 2)</label>
                    <input v-model="newSub.operation_types" class="form-control" placeholder="1">
                </div>
                <div class="col-md-2">
                    <button @click="createSubscription" class="btn btn-success w-100" :disabled="loading || !newSub.reaction_url">
                        <span v-if="loading" class="spinner-border spinner-border-sm"></span>
                        <span v-else>‚ûï –°–æ–∑–¥–∞—Ç—å</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscriptions List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ ({{ subscriptions.length }})</span>
            <button @click="getSubscriptions" class="btn btn-sm btn-outline-primary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 50px">Status</th>
                        <th>ID / Account</th>
                        <th>Reaction URL</th>
                        <th>Ops</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody v-if="subscriptions.length > 0">
                    <template v-for="sub in subscriptions" :key="sub.id">
                        <tr class="sub-row" @click="toggleDetails(sub.id)">
                            <td class="text-center">
                                <span v-if="sub.lost_notifications === 0" title="Healthy" class="text-success fs-5">‚óè</span>
                                <span v-else title="Lost Notifications" class="text-warning fs-5">‚ö†Ô∏è</span>
                            </td>
                            <td>
                                <div class="d-flex flex-column" style="font-size: 0.85rem">
                                    <span class="text-muted small" title="Subscription ID">{{ shortStr(sub.id) }}</span>
                                    <div class="d-flex align-items-center gap-1">
                                        <span class="fw-bold text-truncate-cell" :title="sub.account" style="max-width: 200px;">
                                            {{ sub.account || 'All Accounts' }}
                                        </span>
                                        <span v-if="sub.asset_code" class="badge badge-asset" :title="sub.asset_code + (sub.asset_issuer ? ' / ' + sub.asset_issuer : '')">
                                            {{ sub.asset_code }}
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="text-truncate-cell" :title="sub.reaction_url" style="max-width: 250px;">
                                    <a :href="sub.reaction_url" target="_blank" class="text-decoration-none" @click.stop>{{ sub.reaction_url }}</a>
                                </div>
                            </td>
                            <td>
                                <span v-for="op in sub.operation_types" :key="op" class="badge badge-op">{{ op }}</span>
                            </td>
                            <td class="text-end">
                                <button @click.stop="deleteSubscription(sub.id)" class="btn btn-sm btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                        <tr v-if="expandedSub === sub.id">
                            <td colspan="5" class="p-0">
                                <div class="sub-details p-3">{{ JSON.stringify(sub, null, 2) }}</div>
                            </td>
                        </tr>
                    </template>
                </tbody>
                <tbody v-else>
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <span v-if="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            <span v-else>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Delivery Log -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ ({{ deliveryLog.length }})</span>
            <button @click="getDeliveryLog" class="btn btn-sm btn-outline-primary">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 60px">Status</th>
                        <th>Time</th>
                        <th>Subscription</th>
                        <th>Notification</th>
                        <th>URL</th>
                    </tr>
                </thead>
                <tbody v-if="deliveryLog.length > 0">
                    <template v-for="(entry, idx) in deliveryLog" :key="idx">
                        <tr class="sub-row" @click="toggleDeliveryDetails(idx)">
                            <td class="text-center">
                                <span v-if="entry.status === 'ok'" class="badge bg-success">OK</span>
                                <span v-else class="badge bg-danger" :title="entry.error">ERR</span>
                            </td>
                            <td style="font-size: 0.85rem">{{ formatTime(entry.timestamp) }}</td>
                            <td><span class="text-muted small">{{ shortStr(entry.subscriptionId) }}</span></td>
                            <td><span class="text-muted small">{{ shortStr(entry.notificationId) }}</span></td>
                            <td>
                                <div class="text-truncate-cell" :title="entry.reaction_url" style="max-width: 200px;">
                                    {{ entry.reaction_url }}
                                </div>
                            </td>
                        </tr>
                        <tr v-if="expandedDelivery === idx">
                            <td colspan="5" class="p-0">
                                <div class="sub-details p-3">{{ JSON.stringify(entry.payload, null, 2) }}</div>
                            </td>
                        </tr>
                    </template>
                </tbody>
                <tbody v-else>
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (—Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Status Modal (MOVED INSIDE #app) -->
    <div v-if="showStatusModal" class="modal-backdrop fade show"></div>
    <div v-if="showStatusModal" class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">System Status</h5>
                    <button type="button" class="btn-close" @click="showStatusModal = false"></button>
                </div>
                <div class="modal-body">
                    <div v-if="statusData">
                        <h6 class="text-muted text-uppercase small fw-bold mb-3">General</h6>
                        <div class="kv-row"><span class="kv-key">Version</span><span class="kv-val">{{ statusData.version }}</span></div>
                        <div class="kv-row"><span class="kv-key">Uptime</span><span class="kv-val">{{ statusData.uptime }}</span></div>
                        <div class="kv-row"><span class="kv-key">Subscriptions</span><span class="kv-val">{{ statusData.subscriptions }}</span></div>
                        <div class="kv-row"><span class="kv-key">Observing</span><span class="kv-val" :class="statusData.observing ? 'text-success' : 'text-danger'">{{ statusData.observing }}</span></div>
                        
                        <h6 class="text-muted text-uppercase small fw-bold mt-4 mb-3">Streaming</h6>
                        <div v-if="statusData.stream">
                            <div class="kv-row"><span class="kv-key">Last Ledger (seen)</span><span class="kv-val">{{ statusData.stream.lastLedgerSeen ?? '‚Äî' }}</span></div>
                            <div class="kv-row"><span class="kv-key">Last Ledger (processed)</span><span class="kv-val">{{ statusData.stream.lastLedgerProcessed ?? '‚Äî' }}</span></div>
                            <div class="kv-row"><span class="kv-key">Lag</span><span class="kv-val" :class="statusData.stream.ledgerLag > 10 ? 'text-danger' : 'text-success'">{{ statusData.stream.ledgerLag ?? '‚Äî' }}</span></div>
                            <div class="kv-row"><span class="kv-key">Last Tx</span><span class="kv-val text-truncate" style="max-width: 200px">{{ statusData.stream.lastTxHash }}</span></div>
                            <div class="kv-row"><span class="kv-key">Queue</span><span class="kv-val">{{ statusData.stream.queueLength ?? 0 }}</span></div>
                        </div>
                    </div>
                    <div v-else class="text-center py-4">
                        <span class="spinner-border spinner-border-sm"></span> Loading...
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showStatusModal = false">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Log Drawer (MOVED INSIDE #app) -->
    <div class="console-drawer shadow-lg" :class="{ minimized: minConsole }">
        <div class="console-header" @click="minConsole = !minConsole">
            <span>üìü API Log ({{ logs.length }})</span>
            <span>{{ minConsole ? '‚ñ≤ Expand' : '‚ñº Minimize' }}</span>
        </div>
        <div class="console-body" ref="consoleBody">
            <div v-for="(log, idx) in logs" :key="idx" class="log-entry">
                <span class="log-time">{{ log.time }}</span>
                <span class="log-method" :class="'text-' + getMethodColor(log.method)">{{ log.method }}</span>
                <span class="log-status" :class="'status-' + log.status">{{ log.status || '...' }}</span>
                <span class="log-url text-truncate">{{ log.url }}</span>
                <span class="text-muted small" v-if="log.data" :title="JSON.stringify(log.data)">{...}</span>
            </div>
            <div v-if="logs.length === 0" class="text-muted text-center pt-3">–õ–æ–≥ –ø—É—Å—Ç</div>
        </div>
    </div>

</div> <!-- End of #app -->

<script>
    const { createApp, ref, reactive, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // State
            const config = reactive({
                baseUrl: window.location.origin,
                token: '',
                tokenType: 'Token',
                routes: {
                    status: '/api/status',
                    subscriptions: '/api/subscription',
                    subscriptionResource: '/api/subscription/:id'
                }
            });

            const loading = ref(false);
            const isConnected = ref(false);
            const showConfig = ref(false);
            const showStatusModal = ref(false);
            const statusData = ref(null);

            const minConsole = ref(false);
            const logs = ref([]);
            const consoleBody = ref(null);
            const expandedSub = ref(null);
            const expandedDelivery = ref(null);
            const deliveryLog = ref([]);
            
            // Data
            const subscriptions = ref([]);
            const newSub = reactive({ 
                account: '', 
                reaction_url: '', 
                operation_types: '1' 
            });

            // Init
            onMounted(() => {
                const savedUrl = localStorage.getItem('op_notif_url');
                const savedToken = localStorage.getItem('op_notif_token');

                if (savedUrl) config.baseUrl = savedUrl;
                if (savedToken) config.token = savedToken;
                
                if (savedToken) {
                    isConnected.value = true;
                    getSubscriptions();
                    getDeliveryLog();
                } else {
                    showConfig.value = true;
                }
            });

            // Actions
            const saveConfig = () => {
                localStorage.setItem('op_notif_url', config.baseUrl);
                localStorage.setItem('op_notif_token', config.token);
                isConnected.value = true;
                showConfig.value = false;
                logInternal('CFG', 'Settings saved');
                getSubscriptions();
            };

            const shortStr = (str) => {
                if (!str) return '';
                if (str.length < 8) return str;
                return str.substring(0, 8) + '...';
            };

            const toggleDetails = (id) => {
                expandedSub.value = expandedSub.value === id ? null : id;
            };

            const toggleDeliveryDetails = (idx) => {
                expandedDelivery.value = expandedDelivery.value === idx ? null : idx;
            };

            const formatTime = (ts) => {
                if (!ts) return '';
                return new Date(ts).toLocaleTimeString();
            };

            const getMethodColor = (m) => {
                if (m === 'GET') return 'info';
                if (m === 'POST') return 'success';
                if (m === 'DELETE') return 'danger';
                return 'light';
            };

            // API Wrapper
            const request = async (endpoint, method = 'GET', body = null) => {
                if (!config.baseUrl) return;
                loading.value = true;
                
                const url = config.baseUrl.replace(/\/$/, '') + (endpoint.startsWith('/') ? endpoint : '/' + endpoint);
                const headers = { 'Content-Type': 'application/json' };
                if (config.token) headers['Authorization'] = config.token;

                try {
                    const options = { method, headers };
                    if (body) options.body = JSON.stringify(body);

                    const res = await fetch(url, options);
                    
                    let data;
                    const cType = res.headers.get("content-type");
                    if (cType && cType.includes("application/json")) {
                        data = await res.json();
                    } else {
                        data = await res.text();
                    }

                    addLog(method, endpoint, res.status, data);

                    if (!res.ok) throw new Error(data.error || 'Request failed');
                    return data;
                } catch (e) {
                    addLog(method, endpoint, 'ERR', { error: e.message });
                    return null;
                } finally {
                    loading.value = false;
                }
            };

            const addLog = (method, url, status, data) => {
                logs.value.unshift({
                    time: new Date().toLocaleTimeString(),
                    method, url, status, data
                });
            };
            
            const logInternal = (method, msg) => addLog(method, 'internal', 'OK', msg);

            // Business Logic
            const checkStatus = async () => {
                showStatusModal.value = true;
                statusData.value = null; // Reset for spinner
                const data = await request(config.routes.status);
                if (data) {
                    statusData.value = data;
                } else {
                    showStatusModal.value = false; // Close on error
                }
            };

            const getSubscriptions = async () => {
                const data = await request(config.routes.subscriptions);
                if (Array.isArray(data)) {
                    subscriptions.value = data;
                } else {
                    subscriptions.value = [];
                }
            };

            const getDeliveryLog = async () => {
                const data = await request('/api/delivery-log');
                if (Array.isArray(data)) {
                    deliveryLog.value = data;
                } else {
                    deliveryLog.value = [];
                }
            };

            const createSubscription = async () => {
                const opTypes = newSub.operation_types.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
                const payload = { reaction_url: newSub.reaction_url };
                if (newSub.account) payload.account = newSub.account;
                if (opTypes.length > 0) payload.operation_types = opTypes;

                const res = await request(config.routes.subscriptions, 'POST', payload);
                if (res && res.id) {
                    // Success
                    newSub.account = ''; // Clear fields but keep URL maybe?
                    // newSub.reaction_url = ''; 
                    await getSubscriptions(); // Refresh list
                }
            };

            const deleteSubscription = async (id) => {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É ' + shortStr(id) + '?')) return;
                const path = config.routes.subscriptionResource.replace(':id', id);
                await request(path, 'DELETE');
                await getSubscriptions(); // Refresh list
            };

            return {
                config, loading, isConnected, showConfig, minConsole, logs, consoleBody,
                subscriptions, newSub, expandedSub, expandedDelivery, deliveryLog,
                showStatusModal, statusData, checkStatus,
                saveConfig, createSubscription, deleteSubscription, getSubscriptions,
                getDeliveryLog, toggleDeliveryDetails, formatTime,
                shortStr, getMethodColor, toggleDetails
            };
        }
    }).mount('#app');
</script>

</body>
</html>